trigger: none

pool: 
  name: 'linux-hosted-agent'

variables: 
  - group: terraform-variables
  - group: database-vars

resources:
  pipelines:
    - pipeline: terraformPipeline   # reference name
      source: blessedsoft.epicbook-terraform-ansible     # the name of your Terraform pipeline
      trigger: true                 # optional: automatically trigger when Terraform pipeline completes

parameters:
  - name: 'app_public_ip'
    type: string
    default: $[ dependencies.terraformPipeline.outputs['Terraform_Apply.VM_PUBLIC_IP'] ]
    displayName: 'VM Public IP'
  - name: 'db_host'
    type: string
    default: $[ dependencies.terraformPipeline.outputs['Terraform_Apply.DB_HOST'] ]
    displayName: 'Azure MySQL Endpoint'

stages:
  - stage: ansibleAction
    displayName: 'Ansible Deployment'
    jobs:
      - job: ansiblePlaybook
        displayName: 'Deployment with Ansible'
        steps:
          # --------------------------------------------------------------------
          # Step 1: Validate parameters
          # --------------------------------------------------------------------
          - script: |
              if [ -z "${{ parameters.app_public_ip }}" ] || [ -z "${{ parameters.db_host }}" ]; then
                echo "Error: Both VM Public IP and DB Host are required"
                exit 1
              fi
            displayName: 'Validate Parameters'

          # --------------------------------------------------------------------
          # Step 2: Download SSH Key
          # --------------------------------------------------------------------
          - task: DownloadSecureFile@1
            name: download_ssh_key
            inputs:
              secureFile: "azure_rsa"

          - script: |
              mkdir -p ~/.ssh
              cp $(download_ssh_key.secureFilePath) ~/.ssh/azure_rsa
              chmod 600 ~/.ssh/azure_rsa
              echo "StrictHostKeyChecking no" > ~/.ssh/config
            displayName: "Setup SSH Private Key"

          # --------------------------------------------------------------------
          # Step 3: Create DB vars file dynamically
          # --------------------------------------------------------------------
          - script: |
              mkdir -p vars
              cat > vars/db.yml <<EOF
              ---
              db_host: ${{ parameters.db_host }}
              mysql_admin: '$(mysql_admin)'
              mysql_admin_password: '$(mysql_admin_password)'
              db_name: '$(db_name)'
              db_user: '$(db_user)'
              db_password: '$(db_password)'
              EOF
            workingDirectory: '$(System.DefaultWorkingDirectory)/ansible'
            displayName: 'Create DB YML'

          # --------------------------------------------------------------------
          # Step 4: Create dynamic inventory
          # --------------------------------------------------------------------
          - script: |
              cat > inventory.ini <<EOF
              [app]
              ${{ parameters.app_public_ip }}

              [all:vars]
              ansible_user="azureuser"
              ansible_ssh_private_key_file=~/.ssh/azure_rsa
              ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
              EOF
            workingDirectory: '$(System.DefaultWorkingDirectory)/ansible'
            displayName: 'Create Inventory File'

          # --------------------------------------------------------------------
          # Step 5: Verify files
          # --------------------------------------------------------------------
          - script: |
              echo "=== Inventory file ==="
              cat inventory.ini
              echo "=== Group vars ==="
              ls -la vars/
              cat vars/db.yml
            workingDirectory: '$(System.DefaultWorkingDirectory)/ansible'
            displayName: 'Verify Ansible Files'

          # --------------------------------------------------------------------
          # Step 6: Run Ansible Playbook
          # --------------------------------------------------------------------
          - script: |
              ansible-playbook -i inventory.ini epicbook.yml --ssh-extra-args "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
            workingDirectory: '$(System.DefaultWorkingDirectory)/ansible'
            displayName: 'Run Ansible Playbook'
            env:
              ANSIBLE_HOST_KEY_CHECKING: "False"
