---
- name: Install required packages
  become: yes
  apt:
    name:
      - python3-pip
      - mysql-client
    state: present
    update_cache: yes
  tags: ['database']

- name: Install PyMySQL (for Python-based DB access if needed)
  pip:
    name: PyMySQL
    state: present
  tags: ['database']

# ------------------------------------------------------------------------------
# Create database (using mysql CLI)
# ------------------------------------------------------------------------------
- name: Ensure PyMySQL is installed
  ansible.builtin.pip:
    name: PyMySQL
    state: present

- name: Create application database on Azure MySQL
  ansible.builtin.command: >
    mysql -h {{ db_host }}
    -u {{ mysql_admin }}
    -p{{ mysql_admin_password }}
    -e "CREATE DATABASE IF NOT EXISTS {{ db_name }};"

- name: Create application database user
  ansible.builtin.command: >
    mysql -h {{ db_host }}
    -u {{ mysql_admin }}
    -p{{ mysql_admin_password }}
    -e "CREATE USER IF NOT EXISTS '{{ db_user }}'@'%' IDENTIFIED BY '{{ db_password }}';
        GRANT ALL PRIVILEGES ON {{ db_name }}.* TO '{{ db_user }}'@'%';
        FLUSH PRIVILEGES;"

- name: Check if Author table exists
  shell: |
    mysql -h {{ db_host }} -u {{ db_user }} -p'{{ db_password }}' {{ db_name }} \
    -e "SHOW TABLES LIKE 'Author';"
  register: schema_check
  ignore_errors: yes

- name: Debug schema check
  debug:
    var: schema_check.stdout_lines

# -------------------------------------------------------------------------------
# 3. Import schema and seed data if schema doesn't exist
# -------------------------------------------------------------------------------
- name: Import BuyTheBook schema
  ansible.builtin.mysql_db:
    login_host: "{{ db_host }}"
    login_user: "{{ db_user }}"
    login_password: "{{ db_password }}"
    name: "{{ db_name }}"
    state: import
    target: /home/azureuser/epicbook/db/BuyTheBook_Schema.sql
    ssl_ca: /home/azureuser/epicbook/db/BaltimoreCyberTrustRoot.crt.pem


- name: Import Author seed data
  command: >
    mysql -h {{ db_host }} -u {{ db_user }} -p{{ db_password }} {{ db_name }}
    < /home/azureuser/epicbook/db/author_seed.sql
  when: schema_check is defined and schema_check.stdout == ""

- name: Import Books seed data
  command: >
    mysql -h {{ db_host }} -u {{ db_user }} -p{{ db_password }} {{ db_name }}
    < /home/azureuser/epicbook/db/books_seed.sql
  when: schema_check is defined and schema_check.stdout == ""
  